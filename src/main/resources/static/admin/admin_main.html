<!DOCTYPE html>
<html lang="de-AT">
<head>
    <meta charset="UTF-8">
    <title>Admin Bereich - Pub Quizzz</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 50px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 900px;
        }
        h1 { color: #333; }
        h2 {
            color: #555;
            margin-top: 30px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
        }
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .secondary-btn {
            background-color: #2196F3;
        }
        .secondary-btn:hover {
            background-color: #0b7dda;
        }
        .danger-btn {
            background-color: #f44336;
        }
        .danger-btn:hover {
            background-color: #da190b;
        }
        .back-btn {
            background-color: #888;
            margin-top: 20px;
            grid-column: 1 / -1;
        }
        .back-btn:hover {
            background-color: #666;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #f44336;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #4CAF50;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üìä Admin Bereich</h1>

    <div class="section">
        <h2>Quiz Verwaltung</h2>
        <div class="button-group">
            <button onclick="location.href='create_quiz.html'">‚ûï Neues Quiz anlegen</button>
            <button class="secondary-btn" onclick="viewQuizzes()">üìã Alle Quizze anzeigen</button>
            <button class="secondary-btn" onclick="editQuiz()">‚úèÔ∏è Quiz bearbeiten</button>
            <button class="danger-btn" onclick="deleteQuiz()">üóëÔ∏è Quiz l√∂schen</button>
        </div>
    </div>

    <div class="section">
        <h2>Team Verwaltung</h2>
        <div class="button-group">
            <button onclick="createTeam()">‚ûï Neues Team anlegen</button>
            <button class="secondary-btn" onclick="viewTeams()">üë• Alle Teams anzeigen</button>
            <button class="danger-btn" onclick="deleteTeam()">üóëÔ∏è Team l√∂schen</button>
        </div>
    </div>

    <div class="section">
        <h2>Ergebnisse & Auswertung</h2>
        <div class="button-group">
            <button onclick="viewResults()">üìà Ergebnisse anzeigen</button>
            <button class="secondary-btn" onclick="exportResults()">üíæ Ergebnisse exportieren</button>
            <button onclick="viewLeaderboard()">üèÜ Rangliste anzeigen</button>
        </div>
    </div>

    <div class="section">
        <h2>Benutzerverwaltung</h2>
        <div class="button-group">
            <button onclick="location.href='register_user.html'">‚ûï Neuen Admin User anlegen</button>
            <button class="secondary-btn" onclick="viewUsers()">üë§ User anzeigen</button>
        </div>
    </div>

    <div class="button-group">
        <button class="back-btn" onclick="goBack()">‚Üê Zur√ºck zur Hauptseite</button>
    </div>
</div>

<!-- Modal for displaying data -->
<div id="dataModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modalContent"></div>
    </div>
</div>

<script>
    const API_BASE = '/admin';

    function goBack() {
        window.location.href = '/index.html';
    }

    function closeModal() {
        document.getElementById('dataModal').style.display = 'none';
    }

    function showModal(title, content) {
        const modal = document.getElementById('dataModal');
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `<h2>${title}</h2>${content}`;
        modal.style.display = 'block';
    }

    function showLoading() {
        return '<div class="loading">Laden...</div>';
    }

    function showError(message) {
        return `<div class="error">‚ùå ${message}</div>`;
    }

    function showSuccess(message) {
        return `<div class="success">‚úÖ ${message}</div>`;
    }

    // ==================== Quiz Management ====================

    async function viewQuizzes() {
        showModal('Alle Quizze', showLoading());

        try {
            const response = await fetch(`${API_BASE}/quizzes`);
            const quizzes = await response.json();

            if (quizzes.length === 0) {
                showModal('Alle Quizze', '<p>Keine Quizze gefunden.</p>');
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Ver√∂ffentlicht am</th><th>Abgabedatum</th><th>Fragen</th></tr></thead><tbody>';
            quizzes.forEach(quiz => {
                html += `<tr>
                    <td>${quiz.quizId}</td>
                    <td>${quiz.pubDate}</td>
                    <td>${quiz.submitDate}</td>
                    <td>${quiz.questionCount}</td>
                </tr>`;
            });
            html += '</tbody></table>';

            showModal('Alle Quizze', html);
        } catch (error) {
            showModal('Fehler', showError('Fehler beim Laden der Quizze: ' + error.message));
        }
    }

    async function editQuiz() {
        const quizId = prompt('Quiz ID eingeben:');
        if (!quizId) return;

        try {
            const response = await fetch(`${API_BASE}/quiz/${quizId}`);
            if (!response.ok) {
                alert('Quiz nicht gefunden');
                return;
            }

            const quiz = await response.json();
            const newPubDate = prompt('Neues Ver√∂ffentlichungsdatum (YYYY-MM-DD):', quiz.pubDate);
            const newSubmitDate = prompt('Neues Abgabedatum (YYYY-MM-DD):', quiz.submitDate);

            if (newPubDate && newSubmitDate) {
                const updateResponse = await fetch(`${API_BASE}/quiz/${quizId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pubDate: newPubDate,
                        submitDate: newSubmitDate
                    })
                });

                if (updateResponse.ok) {
                    alert('Quiz erfolgreich aktualisiert!');
                } else {
                    alert('Fehler beim Aktualisieren des Quiz');
                }
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        }
    }

    async function deleteQuiz() {
        const quizId = prompt('Quiz ID zum L√∂schen eingeben:');
        if (!quizId) return;

        if (!confirm(`Quiz ${quizId} wirklich l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden!`)) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/quiz/${quizId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Quiz erfolgreich gel√∂scht!');
            } else {
                alert('Fehler beim L√∂schen des Quiz');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        }
    }

    // ==================== Team Management ====================

    async function createTeam() {
        const teamName = prompt('Team-Namen eingeben:');
        if (!teamName) return;

        try {
            const response = await fetch(`${API_BASE}/team?teamName=${encodeURIComponent(teamName)}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('Team erfolgreich erstellt!');
            } else {
                const message = await response.text();
                alert('Fehler: ' + message);
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        }
    }

    async function viewTeams() {
        showModal('Alle Teams', showLoading());

        try {
            const response = await fetch(`${API_BASE}/teams`);
            const teams = await response.json();

            if (teams.length === 0) {
                showModal('Alle Teams', '<p>Keine Teams gefunden.</p>');
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Team-Name</th></tr></thead><tbody>';
            teams.forEach(team => {
                html += `<tr>
                    <td>${team.teamsId}</td>
                    <td>${team.teamName}</td>
                </tr>`;
            });
            html += '</tbody></table>';

            showModal('Alle Teams', html);
        } catch (error) {
            showModal('Fehler', showError('Fehler beim Laden der Teams: ' + error.message));
        }
    }

    async function deleteTeam() {
        const teamId = prompt('Team ID zum L√∂schen eingeben:');
        if (!teamId) return;

        if (!confirm(`Team ${teamId} wirklich l√∂schen?`)) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/team/${teamId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Team erfolgreich gel√∂scht!');
            } else {
                alert('Fehler beim L√∂schen des Teams');
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        }
    }

    // ==================== Results Management ====================

    async function viewResults() {
        const quizId = prompt('Quiz ID f√ºr Ergebnisse eingeben (leer = alle):');

        showModal('Ergebnisse', showLoading());

        try {
            const url = quizId ? `${API_BASE}/results?quizId=${quizId}` : `${API_BASE}/results`;
            const response = await fetch(url);
            const results = await response.json();

            if (results.length === 0) {
                showModal('Ergebnisse', '<p>Keine Ergebnisse gefunden.</p>');
                return;
            }

            let html = '<table><thead><tr><th>Team</th><th>Quiz Datum</th>';
            for (let i = 1; i <= 8; i++) {
                html += `<th>Q${i}</th>`;
            }
            html += '<th>Gesamt</th></tr></thead><tbody>';

            results.forEach(result => {
                html += `<tr>
                    <td>${result.teamName}</td>
                    <td>${result.quizDate}</td>
                    <td>${result.answer1Points || 0}${result.changedAnswer1 ? '*' : ''}</td>
                    <td>${result.answer2Points || 0}${result.changedAnswer2 ? '*' : ''}</td>
                    <td>${result.answer3Points || 0}${result.changedAnswer3 ? '*' : ''}</td>
                    <td>${result.answer4Points || 0}${result.changedAnswer4 ? '*' : ''}</td>
                    <td>${result.answer5Points || 0}${result.changedAnswer5 ? '*' : ''}</td>
                    <td>${result.answer6Points || 0}${result.changedAnswer6 ? '*' : ''}</td>
                    <td>${result.answer7Points || 0}${result.changedAnswer7 ? '*' : ''}</td>
                    <td>${result.answer8Points || 0}${result.changedAnswer8 ? '*' : ''}</td>
                    <td><strong>${result.totalPoints}</strong></td>
                </tr>`;
            });
            html += '</tbody></table>';
            html += '<p style="margin-top: 10px; color: #666;"><em>* = Antwort wurde ge√§ndert</em></p>';

            showModal('Ergebnisse', html);
        } catch (error) {
            showModal('Fehler', showError('Fehler beim Laden der Ergebnisse: ' + error.message));
        }
    }

    async function exportResults() {
        const quizId = prompt('Quiz ID f√ºr Export eingeben (leer = alle):');

        try {
            const url = quizId ? `${API_BASE}/results/export?quizId=${quizId}` : `${API_BASE}/results/export`;
            window.open(url, '_blank');
        } catch (error) {
            alert('Fehler: ' + error.message);
        }
    }

    async function viewLeaderboard() {
        const quizId = prompt('Quiz ID f√ºr Rangliste eingeben (leer = alle):');

        showModal('Rangliste', showLoading());

        try {
            const url = quizId ? `${API_BASE}/leaderboard?quizId=${quizId}` : `${API_BASE}/leaderboard`;
            const response = await fetch(url);
            const leaderboard = await response.json();

            if (leaderboard.length === 0) {
                showModal('Rangliste', '<p>Keine Ergebnisse gefunden.</p>');
                return;
            }

            let html = '<table><thead><tr><th>Rang</th><th>Team</th><th>Quiz Datum</th><th>Punkte</th></tr></thead><tbody>';
            leaderboard.forEach(entry => {
                const rankEmoji = entry.rank === 1 ? 'ü•á' : entry.rank === 2 ? 'ü•à' : entry.rank === 3 ? 'ü•â' : entry.rank;
                html += `<tr>
                    <td>${rankEmoji}</td>
                    <td>${entry.teamName}</td>
                    <td>${entry.quizDate}</td>
                    <td><strong>${entry.totalPoints}</strong></td>
                </tr>`;
            });
            html += '</tbody></table>';

            showModal('üèÜ Rangliste', html);
        } catch (error) {
            showModal('Fehler', showError('Fehler beim Laden der Rangliste: ' + error.message));
        }
    }

    // ==================== User Management ====================

    async function viewUsers() {
        showModal('Alle Benutzer', showLoading());

        try {
            const response = await fetch(`${API_BASE}/users`);
            const users = await response.json();

            if (users.length === 0) {
                showModal('Alle Benutzer', '<p>Keine Benutzer gefunden.</p>');
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Benutzername</th></tr></thead><tbody>';
            users.forEach(user => {
                html += `<tr>
                    <td>${user.userId}</td>
                    <td>${user.username}</td>
                </tr>`;
            });
            html += '</tbody></table>';

            showModal('Alle Benutzer', html);
        } catch (error) {
            showModal('Fehler', showError('Fehler beim Laden der Benutzer: ' + error.message));
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('dataModal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
</body>
</html>